<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Sales Report</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f9f9f9;
    color: #000;
  }
  #reportContainer {
    width: 210mm;
    min-height: 297mm;
    margin: auto;
    background: #fff;
    padding: 25px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    page-break-after: always;
  }
  h1, h2, h3 { text-align: center; margin: 10px 0; color: #000; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 12px;
    color: #000;
  }
  th, td {
    border: 1px solid #333;
    padding: 6px;
    text-align: left;
  }
  th {
    background: #ccc;
    color: #000;
  }
  .summary {
    margin-top: 20px;
    font-size: 13px;
  }
  .summary div {
    margin-bottom: 6px;
    font-weight: bold;
  }
  .voided {
    color: #900;
    font-weight: bold;
  }
  button {
    margin: 10px 5px 20px 0;
    padding: 10px 15px;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid #333;
    background: #ccc;
    color: #000;
  }
  button:hover {
    background: #aaa;
  }
  @media print {
    body { background: #fff; }
    #reportContainer { box-shadow: none; margin: 0; width: auto; min-height: auto; }
    button, label, input { display: none; }
  }
</style>
</head>
<body>

<h1 id="companyName">Company Name</h1>

<label for="reportDate">Select Date:</label>
<input type="date" id="reportDate">
<button id="generateBtn">Generate Report</button>
<button onclick="printReport()">Print Report</button>

<div id="reportContainer" style="display:none;">
  <h2 id="reportTitle"></h2>

  <h3>Active Receipts</h3>
  <table id="receiptsTable">
    <thead>
      <tr>
        <th>Receipt No</th>
        <th>Flight No</th>
        <th>Payment Type</th>
        <th>Currency</th>
        <th>Total Amount</th>
        <th>Batch No</th>
        <th>Approval Code</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Voided Receipts</h3>
  <table id="voidedTable">
    <thead>
      <tr>
        <th>Receipt No</th>
        <th>Payment Type</th>
        <th>Currency</th>
        <th>Total Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary" id="summaryDiv"></div>
</div>

<script src="Co.js"></script>
<script>
document.getElementById("companyName").innerText = companyInfo.name || "Company Name";
</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire1.js"></script>

<script>
const reportDateInput = document.getElementById("reportDate");
const generateBtn = document.getElementById("generateBtn");
const reportContainer = document.getElementById("reportContainer");
const reportTitle = document.getElementById("reportTitle");
const summaryDiv = document.getElementById("summaryDiv");
const receiptsTableBody = document.querySelector("#receiptsTable tbody");
const voidedTableBody = document.querySelector("#voidedTable tbody");

generateBtn.addEventListener("click", async () => {
  const selectedDate = reportDateInput.value;
  if(!selectedDate) return alert("Select a valid date");

  reportContainer.style.display = "block";
  reportTitle.innerText = `Sales Report for ${selectedDate}`;

  try {
    const start = new Date(selectedDate + "T00:00:00");
    const end = new Date(selectedDate + "T23:59:59");

    const snapshot = await db.collection("bookings")
      .where("timestamp", ">=", start)
      .where("timestamp", "<=", end)
      .get();

    let totalsCashByCurrency = {};
    let totalsNonCashByTypeCurrency = {};
    let voidedByTypeCurrency = {};

    receiptsTableBody.innerHTML = "";
    voidedTableBody.innerHTML = "";

    snapshot.docs.forEach(doc => {
      const data = doc.data();

      const key = `${data.paymentType} (${data.currency})`;

      if(data.voided){
        // Voided totals to subtract later
        if(data.paymentType.toLowerCase() === "cash"){
          if(!voidedByTypeCurrency[data.currency]) voidedByTypeCurrency[data.currency] = 0;
          voidedByTypeCurrency[data.currency] += data.total;
        } else {
          if(!voidedByTypeCurrency[key]) voidedByTypeCurrency[key] = 0;
          voidedByTypeCurrency[key] += data.total;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td>-</td>
          <td>${data.paymentType}</td>
          <td>${data.currency}</td>
          <td>${data.total.toFixed(2)}</td>
        `;
        voidedTableBody.appendChild(tr);

      } else {
        // Active receipts table
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td>${data.flight || '-'}</td>
          <td>${data.paymentType}</td>
          <td>${data.currency}</td>
          <td>${data.total.toFixed(2)}</td>
          <td>${data.batchNo || '-'}</td>
          <td>${data.approvalCode || '-'}</td>
          <td>Active</td>
        `;
        receiptsTableBody.appendChild(tr);

        if(data.paymentType.toLowerCase() === "cash"){
          if(!totalsCashByCurrency[data.currency]) totalsCashByCurrency[data.currency] = 0;
          totalsCashByCurrency[data.currency] += data.total;
        } else {
          if(!totalsNonCashByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] = 0;
          totalsNonCashByTypeCurrency[key] += data.total;
        }
      }
    });

    // Subtract voided amounts
    for(const curr in totalsCashByCurrency){
      if(voidedByTypeCurrency[curr]) totalsCashByCurrency[curr] -= voidedByTypeCurrency[curr];
    }
    for(const key in totalsNonCashByTypeCurrency){
      if(voidedByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] -= voidedByTypeCurrency[key];
    }

    // Build summary
    summaryDiv.innerHTML = "<h3>Summary (Active Receipts Only, Voided Excluded)</h3>";

    for(const curr in totalsCashByCurrency){
      summaryDiv.innerHTML += `<div>Total Cash in ${curr}: ${totalsCashByCurrency[curr].toFixed(2)}</div>`;
    }

    for(const key in totalsNonCashByTypeCurrency){
      summaryDiv.innerHTML += `<div>Total by ${key}: ${totalsNonCashByTypeCurrency[key].toFixed(2)}</div>`;
    }

  } catch(err){
    console.error("Error generating report:", err);
    alert("Error generating report: "+err.message);
  }
});

function printReport(){
  window.print();
}
</script>
</body>
</html>
