<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Update Payments</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f6f9; margin:20px; }
  h2 { text-align:center; margin-bottom:20px; }
  table { width:100%; border-collapse:collapse; margin-bottom:20px; }
  th, td { border:1px solid #ccc; padding:6px; font-size:13px; text-align:center; }
  th { background:#eee; }
  input, select { width:70%; padding:4px; font-size:13px; }
  button { padding:6px 10px; margin:2px; font-size:13px; cursor:pointer; }
  button.update { background:#007bff; color:white; border:none; border-radius:4px; }
  button.update:hover { background:#0056b3; }
  button.print { background:#28a745; color:white; border:none; border-radius:4px; }
  button.print:hover { background:#1e7e34; }
</style>
</head>
<body>

<h2>Update Payments</h2>
<table id="paymentsTable">
  <thead>
    <tr>
      <th>Receipt No</th>
      <th>Name</th>
      <th>Flight</th>
      <th>Total</th>
      <th>Payment Type</th>
      <th>Batch No</th>
      <th>Approval Code</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire1.js"></script>

<script>
const tableBody = document.querySelector("#paymentsTable tbody");

// Load payments needing refinement
async function loadPayments() {
  tableBody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";
  let results = [];

  // Query 1: Card (generic quick entries)
  const cardSnap = await db.collection("bookings")
    .where("paymentType", "==", "Card")
    .get();
  cardSnap.forEach(doc => results.push({ id: doc.id, ...doc.data() }));

  // Query 2: Non-cash but incomplete
  const nonCashSnap = await db.collection("bookings")
    .where("paymentType", "!=", "Cash")
    .get();
  nonCashSnap.forEach(doc => {
    const d = doc.data();
    if (!d.batchNo || !d.approvalCode) {
      results.push({ id: doc.id, ...d });
    }
  });

  // Deduplicate by receiptNo
  const unique = {};
  results.forEach(r => unique[r.receiptNo] = r);
  results = Object.values(unique);

  if (results.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='8'>No pending approvals</td></tr>";
    return;
  }

  tableBody.innerHTML = "";
  results.forEach(data => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${data.receiptNo}</td>
      <td>${data.name || ""}</td>
      <td>${data.flight || ""}</td>
      <td>${Number(data.total || 0).toFixed(2)} ${data.currency || ""}</td>
      <td>
        <select class="payType">
          <option ${data.paymentType==="Cash"?"selected":""}>Cash</option>
          <option ${data.paymentType==="Card"?"selected":""}>Card</option>
          <option ${data.paymentType==="Visa"?"selected":""}>Visa</option>
          <option ${data.paymentType==="MasterCard"?"selected":""}>MasterCard</option>
          <option ${data.paymentType==="Amex"?"selected":""}>Amex</option>
          <option ${data.paymentType==="UnionPay"?"selected":""}>UnionPay</option>
          <option ${data.paymentType==="Other"?"selected":""}>Other</option>
        </select>
      </td>
      <td><input type="text" class="batchNo" value="${data.batchNo || ""}"></td>
      <td><input type="text" class="approvalCode" value="${data.approvalCode || ""}"></td>
      <td>
        <button class="update">Update</button>
        <button class="print">Print</button>
      </td>
    `;

    // Update handler
    row.querySelector(".update").addEventListener("click", async () => {
      const newPayType = row.querySelector(".payType").value;
      const batchNo = row.querySelector(".batchNo").value.trim();
      const approvalCode = row.querySelector(".approvalCode").value.trim();

      if (newPayType === "Cash") {
        if (batchNo || approvalCode) {
          alert("Cash payments must not have Batch No or Approval Code.");
          return;
        }
      } else if (newPayType === "Card") {
        alert("Please specify the actual card type (Visa, MasterCard, etc.) before saving.");
        return;
      } else {
        if (!batchNo || !approvalCode) {
          alert("Non-cash payments require Batch No and Approval Code.");
          return;
        }
      }

      await db.collection("bookings").doc(data.id).update({
        paymentType: newPayType,
        batchNo: newPayType==="Cash" ? null : batchNo,
        approvalCode: newPayType==="Cash" ? null : approvalCode
      });
      alert("Updated!");
    });

    // Print handler -> opens Receipt Viewer page
    row.querySelector(".print").addEventListener("click", () => {
      const updated = {
        ...data,
        paymentType: row.querySelector(".payType").value,
        batchNo: row.querySelector(".batchNo").value.trim(),
        approvalCode: row.querySelector(".approvalCode").value.trim()
      };

      // Save booking data to localStorage
      localStorage.setItem("printBooking", JSON.stringify(updated));

      // Open receipt viewer page
      window.open("receiptViewer.html", "_blank");
    });

    tableBody.appendChild(row);
  });
}

loadPayments();
</script>

</body>
</html>
