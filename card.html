<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Booking Form</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #f4f6f9; 
    margin: 10px; 
  }
  h2 { 
    text-align: center; 
    color: #333; 
    margin-bottom: 15px;
  }
  form { 
    max-width: 800px; 
    margin: auto; 
    background: #fff; 
    padding: 15px; 
    border-radius: 10px; 
    box-shadow: 0 3px 15px rgba(0,0,0,0.1); 
    font-size: 14px;
  }
  label { 
    display: block; 
    margin-top: 6px; 
    font-weight: bold; 
    font-size: 13px;
  }
  input, select, button { 
    padding: 6px; 
    width: 100%; 
    margin-top: 3px; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    box-sizing: border-box; 
    font-size: 13px;
  }
  .readonly-field { background: #f0f0f0; }
  .form-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 15px; 
    margin-top: 10px; 
  }
  .full-width { grid-column: 1 / -1; }
  .totals, .cash-section { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 10px; 
    margin-top: 10px; 
  }
  button { 
    width: 100%; 
    background: #007bff; 
    color: white; 
    font-size: 1rem; 
    cursor: pointer; 
    margin-top: 15px; 
    padding: 10px; 
  }
  button:hover { background: #0056b3; }
  #receiptNo { display: none; } /* hide receipt field */
</style>
</head>
<body>

<h2>Booking Entry</h2>

<form id="bookingForm">
  <label for="qrInput">Scan/Paste QR Code (optional):</label>
  <input type="text" id="qrInput" placeholder="Paste or scan QR code here" class="full-width">

  <div class="form-grid">
    <div>
      <label>Date:</label>
      <input type="date" id="date">
      <label>Name:</label>
      <input type="text" id="name">
      <label>Flight No:</label>
      <input type="text" id="flight">
      <label>Seat No:</label>
      <input type="text" id="seat">
    </div>

    <div>
      <label>Currency:</label>
      <select id="currencyType">
        <option value="USD">USD</option>
        <option value="MVR">MVR</option>
      </select>
      <label>Rate:</label>
      <select id="rateType">
        <option value="A" selected>Rate A</option>
        <option value="B">Rate B</option>
      </select>
      <label>Adults:</label>
      <input type="number" id="adultCount" value="0" min="0">
      <label>Kids:</label>
      <input type="number" id="kidCount" value="0" min="0">
    </div>

    <div class="full-width">
      <label>Payment Type:</label>
      <select id="paymentType">
        <option value="Card" selected>Card</option>
        <option value="Cash">Cash</option>
      </select>

      <div id="cashFields" class="cash-section">
        <div>
          <label>Given Amount:</label>
          <input type="number" id="givenAmount" min="0" step="0.01">
        </div>
        <div>
          <label>Balance:</label>
          <input type="text" id="balanceField" class="readonly-field" readonly>
        </div>
      </div>

      <input type="text" id="receiptNo" class="readonly-field" readonly>
    </div>
  </div>

  <div class="totals">
    <div>
      <label>Total Adults:</label>
      <input type="text" id="totalAdults" class="readonly-field" readonly>
    </div>
    <div>
      <label>Total Kids:</label>
      <input type="text" id="totalKids" class="readonly-field" readonly>
    </div>
    <div>
      <label>GST:</label>
      <input type="text" id="gstField" class="readonly-field" readonly>
    </div>
    <div>
      <label>Total:</label>
      <input type="text" id="totalField" class="readonly-field" readonly>
    </div>
  </div>

  <button type="button" id="saveBtn">Save</button>
</form>

<div id="output" style="max-width:800px;margin:15px auto;font-size:14px;"></div>

<script src="rate.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire1.js"></script>
<script src="Co.js"></script> <!-- Company info -->

<script>
const dateField = document.getElementById("date");
const qrInput = document.getElementById("qrInput");
const nameField = document.getElementById("name");
const flightField = document.getElementById("flight");
const seatField = document.getElementById("seat");
const currencyType = document.getElementById("currencyType");
const rateType = document.getElementById("rateType");
const adultCount = document.getElementById("adultCount");
const kidCount = document.getElementById("kidCount");
const paymentType = document.getElementById("paymentType");
const givenAmount = document.getElementById("givenAmount");
const balanceField = document.getElementById("balanceField");
const cashFields = document.getElementById("cashFields");
const receiptNo = document.getElementById("receiptNo");
const totalAdultsField = document.getElementById("totalAdults");
const totalKidsField = document.getElementById("totalKids");
const gstField = document.getElementById("gstField");
const totalField = document.getElementById("totalField");
const outputDiv = document.getElementById("output");

dateField.value = new Date().toISOString().split('T')[0];
cashFields.style.display = "none";

// Toggle cash fields
function toggleCashFields() {
  if(paymentType.value==="Cash"){
    cashFields.style.display = "grid";
  } else {
    cashFields.style.display = "none";
    givenAmount.value = "";
    balanceField.value = "";
  }
}

// Calculate totals
function calculate(){
  const curr = currencyType.value;
  const rate = rateType.value;
  const adults = parseInt(adultCount.value)||0;
  const kids = parseInt(kidCount.value)||0;
  const adultKey = `Adult${rate}${curr}`;
  const kidKey = `Kids${rate}${curr}`;
  const adultRate = rates[adultKey].price;
  const kidRate = rates[kidKey].price;
  const gstPercent = rates[adultKey].GST;
  const totalAdults = adults*adultRate;
  const totalKids = kids*kidRate;
  const subtotal = totalAdults+totalKids;
  const gstAmount = subtotal*(gstPercent/100);
  const total = subtotal+gstAmount;

  totalAdultsField.value = totalAdults.toFixed(2);
  totalKidsField.value = totalKids.toFixed(2);
  gstField.value = gstAmount.toFixed(2);
  totalField.value = total.toFixed(2);

  if(paymentType.value==="Cash"){
    const given = parseFloat(givenAmount.value)||0;
    balanceField.value = (given-total).toFixed(2);
  } else balanceField.value = "";

  return {subtotal, gstAmount, total};
}

// Event listeners
paymentType.addEventListener("change", ()=>{
  toggleCashFields();
  calculate();
});
[currencyType, rateType, adultCount, kidCount, givenAmount].forEach(el=>{
  el.addEventListener("input", calculate);
  el.addEventListener("change", calculate);
});
window.addEventListener("DOMContentLoaded", ()=>{ toggleCashFields(); calculate(); });

// Get next receipt number
async function getNextReceiptNo() {
  const counterRef = db.collection("counters").doc("receiptCounter");
  try {
    const nextReceiptNo = await db.runTransaction(async (transaction)=>{
      const doc = await transaction.get(counterRef);
      let current = doc.exists ? doc.data().current + 1 : 1;
      if(doc.exists) transaction.update(counterRef, {current: current});
      else transaction.set(counterRef, {current: current});
      return current;
    });
    return nextReceiptNo;
  } catch(err){
    console.error(err); return 1;
  }
}

// Print receipt (same design as Receipt Viewer)
async function printReceipt(receiptNumber){
  try {
    const snapshot = await db.collection("bookings").where("receiptNo","==",receiptNumber).limit(1).get();
    if(snapshot.empty){ alert("Receipt not found!"); return; }
    const booking = snapshot.docs[0].data();
    let copies = parseInt(prompt("How many receipts to print?", "1"));
    if(isNaN(copies)||copies<1) copies=1;

    for(let i=0;i<copies;i++){
      const win = window.open('','PRINT','height=600,width=400');
      win.document.write(`
        <html>
        <head>
        <title>Receipt ${booking.receiptNo}</title>
        <style>
          body { font-family: monospace; font-size:12px; padding:5px; width:80mm; }
          .company-header { text-align:center; font-weight:bold; font-size:14px; margin-bottom:4px; }
          .company-info { text-align:center; font-size:11px; margin-bottom:4px; }
          .line { border-bottom:1px dashed #000; margin:4px 0; }
          .row { display:flex; justify-content:space-between; }
          @media print { body { margin:0; } }
        </style>
        </head>
        <body>
          <div class="company-header">${company.name}</div>
          <div class="company-info">${company.address}<br>${company.phone}</div>
          <h3 style="text-align:center;">Receipt</h3>
          <div class="line"></div>
          <p>Receipt No: ${booking.receiptNo}</p>
          <p>Date: ${booking.date || ''}</p>
          <p>Name: ${booking.name || ''}</p>
          <p>Flight No: ${booking.flight || ''}</p>
          <p>Seat No: ${booking.seat || ''}</p>
          <div class="row"><span>Adults:</span><span>${booking.adults??0}</span></div>
          <div class="row"><span>Kids:</span><span>${booking.kids??0}</span></div>
          <div class="row"><span>GST:</span><span>${(booking.gst??0).toFixed(2)}</span></div>
          <div class="row"><strong>Total:</strong><strong>${(booking.total??0).toFixed(2)} ${booking.currency||''}</strong></div>
          <p>Payment Method: ${booking.paymentType||''}</p>
          ${
            booking.paymentType==='Cash'
            ? `<div class="row"><span>Given:</span><span>${(booking.givenAmount??0).toFixed(2)}</span></div>
               <div class="row"><span>Balance:</span><span>${(booking.balance??0).toFixed(2)}</span></div>`
            : ''
          }
          <div class="line"></div>
          <p style="text-align:center;">Valid for 3 hours only</p>
        </body>
        </html>
      `);
      win.document.close();
      win.focus();
      win.print();
      win.close();
    }

  } catch(err){ console.error(err); alert("Error printing receipt: "+err.message); }
}

// Save booking
document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const totals = calculate();
  const nextReceiptNo = await getNextReceiptNo();
  receiptNo.value = nextReceiptNo;

  const data = {
    date: dateField.value,
    qrCode: qrInput.value || null,
    name: nameField.value,
    flight: flightField.value,
    seat: seatField.value,
    currency: currencyType.value,
    rate: rateType.value,
    adults: parseInt(adultCount.value)||0,
    kids: parseInt(kidCount.value)||0,
    paymentType: paymentType.value,
    givenAmount: paymentType.value==='Cash'?parseFloat(givenAmount.value)||0:null,
    balance: paymentType.value==='Cash'?parseFloat(balanceField.value)||0:null,
    receiptNo: nextReceiptNo,
    totalAdults: parseFloat(totalAdultsField.value),
    totalKids: parseFloat(totalKidsField.value),
    gst: parseFloat(gstField.value),
    total: parseFloat(totalField.value),
    timestamp: new Date()
  };

  try {
    await db.collection("bookings").add(data);
    outputDiv.innerHTML = `<p style="color:green;">Booking saved successfully! Receipt No: ${nextReceiptNo}</p>`;
    document.getElementById("bookingForm").reset();
    dateField.value = new Date().toISOString().split('T')[0];
    toggleCashFields();
    calculate();

    if(confirm("Do you want to print the receipt?")){
      printReceipt(nextReceiptNo);
    }
  } catch(err){
    console.error(err);
    outputDiv.innerHTML = `<p style="color:red;">Error saving booking: ${err.message}</p>`;
  }
});
</script>
</body>
</html>
